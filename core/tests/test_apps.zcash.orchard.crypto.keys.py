from common import *
from apps.zcash.orchard.crypto.keys import FullViewingKey, sk_to_ask
from apps.zcash.orchard.crypto.address import Address
from apps.zcash.orchard.crypto.note import Note
from trezor.crypto.pallas import Fp

ZCASH_TEST_VECTORS = [
    ["From https://github.com/zcash-hackworks/zcash-test-vectors/blob/master/orchard_key_components.py"],
    ["sk, ask, ak, nk, rivk, ivk, ovk, dk, default_d, default_pk_d, internal_rivk, internal_ivk, internal_ovk, internal_dk, note_v, note_rho, note_rseed, note_cmx, note_nf"],
    ["5d7a8f739a2d9e945b0ce152a8049e294c4d6e66b164939daffa2ef6ee692148", "8eb8c401c287a6c13a2c345ad82172d86be4a8853525db602d14f630f4e61c17", "740bbe5d0580b2cad430180d02cc128b9a140d5e07c151721dc16d25d4e20f15", "9f2f826738945ad01f47f70db0c367c246c20c61ff5583948c39dea968fefd1b", "021ccf89604f5f7cc6e034b32d338908b819fbe325fee6458b56b4ca71a7e43d", "85c8b5cd1ac3ec3ad7092132f97f0178b075c81a139fd460bbe0dfcd75514724", "bcc7065e59910b35993f59505be209b14bf02488750bbc8b1acdcf108c362004", "31d6a685be570f9faf3ca8b052e887840b2c9f8d67224ca82aefb9e2ee5bedaf", "8ff3386971cb64b8e77899", "08dd8ebd7de92a68e586a34db8fea999efd2016fae76750afae7ee941646bcb9", "901a30b99ae1570cb80bb616aeef3bb916c640c4cc620f9b4b4499c74332eb2a", "906e2d20d00dc0bf7c520687d9df3ce9814d30ee05c215f8764a32c362f9262f", "d7268bebbee692286252ac60bd4df405ea499d697c454773c5c43cb170930123", "6d61a03f746ba93b932402ac1071fc2759d4f4d684b2c5056d5b177af0fa8aa9", 15643327852135767324, "2cb5b406ed8985e18130ab33362697b0e4e4c763ccb8f676495c222f7fba1e31", "defa3d5a57efc2e1e9b01a035587d5fb1a38e01d94903d3c3e0ad3360c1d3710", "4502e339901e397717839167cbb4037e0ecf6813b51c81fe085a7b782f124228", "1b32edbbe4d18f28876de262518ad31122701f8c0a52e98047a337876e7eea19"],
    ["acd20b183e31d49f25c9a138f49b1a537edcf04be34a9851a7af9db6990ed83d", "41d47cc96313b4821dfc129651c3137f44d9cad16b3dc08133c3d2df0d0c5320", "6de1349830d66d7b97fe231fc7b02ad64323629cfed1e3aa24ef052f56e4002a", "a8b73d979b6eaada8924bcbdc63a9ef4e87346f230aba6bbe1e2b43c5bea6b22", "dacb2f2a9ced363171821aaf5d8cd902bc5e3a5a41fb51ae61a9f02dc89d1d12", "563a6db60c74c2db08492cbae3bb083f1aeabffbcf42551d0ac64f2690536711", "71cd30640fdb63f8d1305029e940e53fd5ec04a8ccad419578c242fec05b9af7", "9d9bd44525e7ae06b03ae6d4aecde6ae0927a7c667d5d9f8176b544695dfec11", "7807ca650858814d5022a8", "3d3de4d52c77fd0b630a40dc38212487b2ff6eeef56d8c6a6163e854aff04189", "8a22a7f5a1e91a92ad394b18eb7338b592470dd42be8ef84c93e7cd845ecfa32", "121183cb3b8d06f599bb38b37322851e5fc95ad0c9707ee85fb65e21f1a30d13", "93252b24b491d9c9c99765c84d4ac7c2bff054cd9cadcd3e01b26f21e2840909", "6eea18fd0d50707f90df002cbf309eca3c00d398aede1fdc2abffc88353859af", 4481649511318637270, "a51b0052ad8084a8b9da948d320dadd64f5431e61ddf658d24ae67c22c8d1309", "131fc00fe7f235734276d38d47f1e191e00c7a1d48af046827591e9733a97fa6", "c7ad794c563e32cad47d47dcda7884692848dce29ba4febd93202b7305f90300", "2cf067bc21d66320e51b9fbdc8ae031c2c96373db43b7b1a45056c00c65d4320"],
    ["b679f3dc601d008285edcbdae69ce8fc1be4aac00ff2711ebd931de518856878", "ce8b65a7236511b2eaf19f72a3d6db7d062b66f516307d198706e5f6928e1615", "efa5f1debeead0940a619ce0017bedb426657b2d07406664d895312ea1c3b334", "04514ea048b94363dea7cb3be8d62582ac52922e0865f662743b05eae8715f17", "2a328f994f6e5ad29ca811ed344968ea2cfc3fd231030e37bbd56db42640231c", "609ecbc3d8cee3be2b2a2362951f58b74482adfaeee1c40f94030440f558aa30", "dfd30f62aa319c6f53e24c1f48c1de961b9001cb988b80b3eda244fcfeb25f83", "236bc3f3d02f960280eedede108d3685049f239aa67c48558f7c01d3fd469ecd", "6424f71a3ad197426498f4", "eccb6a5780204237987232bc098f89acc475c3f74bd69e2f35d44736f48f3c14", "0aa9aaaa2cf18490ddf9a7e521071407ea9bfffe843429bc94a288e8a606a710", "a06abd29d5a199e1c21025b0337e941f6d4d84eb7cc35a397f9e753fdaed810d", "f82eb24906e294ff6571ac7d8368ea8280d422f3477ce72aef5f9b9eca48468f", "3656b545a50a6b26287476641b2b68c63c36f332e74557e916050f0b9111179b", 14496603531126387959, "32b4f473f468a008e72389fc03880d780cb07fcfaabe3f1a84b27db59a4a153d", "882d2b2103596555ed9494c6ac893c49723833ec8926c1039586a7afcf4a0d9c", "03ce20cea194b7559a8a90471d28a3c053c3720ad49f40d27c2dcce335005616", "16fa2c3497fc09ad90dd349202a24b69892dc80629b2d1bfebaf41708f0fb10c"],
    ["731e985d99589c8bb838e8aaf745533ed9e8ae3a1cd074a51a20da8aba18d1db", "426a7844f305b9d4e07ea52a39001c9b336cfc0d6fa15ef3d11c3d7b74f08c2d", "b1e0acbc69bf377b85abf0f5a10be72c3b640006ff08505280e4f00fadf76328", "cf36ad6a066cd213e1d767ab071dc1167885c4168bc2e2175448563ad13f333d", "c41bbad35105a80314b79624b675241220b331f12592617bdb705bfcce72ae38", "f79fe802e4d24307a6aaf85d19f5e0833740bae598dc7c880ac609631de15819", "f96366bc6eabd232549ebb43b4ed6fd81d330373c5b566904e9af11a6bab8d77", "803e348573022bf8932f23ee7a325ea283879c652412b8606be3198c4b782c47", "db8c305524bc0deaa85d97", "04ea8c1320ffbbadfe96f0c6ff16b607111b5583bfb6f1ea45275ef2aa2d879b", "9e452ab72c6c8eccf2e439a0cec0a0ac394a1aa121ac6032a7ebc29db4856226", "3ba93b0fc3f27ab217635d03f90d0b842d99a12cdc37a81c181ec018e5f44c11", "e3c7f86c1b2383b3bd41ad1a8f11efa2554a410a98c89207aeb4319b1abd7879", "d71a68cfd6c768f43073f698189ac75ee421b4204bb6f3c5d0fc432849aa7161", 6792346249443327211, "4b192232ecb9f0c02411e52596bc5e90457e745939ffedbd12863ce71a02af11", "7d417adb3d15cc54dcb1fce467500c6b8fb86b12b56da9c382857deecc40a98d", "a9b11baf3034b65c6424841bfe023f8eda1313c30aa27de92e21a108316e8219", "72d6308960351f7b26fa64603fe4dfd867bd5eb367ba2b7ca491c923c0ead222"],
    ["5f2935395ee4762dd21afdbb5d47fa9a6dd984d567db2857b927b7fae2db5871", "118073285164e6557358fbc41a8135cb062f8676cb61f9aa52d19a09fac55802", "0d262de3609433fe5b7c862bc48ef56d832009f7242e1f7c770a12241dfa2807", "51baf333cff1f2d0c7e3cff4d301299dc1efe98300314a541938029b45cc1521", "228feb79219873c7a7606e52973c85f460465a6059083919ed73eb805c118301", "76f49cf8a3192185616a9a0da0c76ec2c2756159bce186a1862b6e6e59442d11", "eb72b6c31e837fd837aacb61fabace75a19dd9dd5b4b3a3ee723c14da77b4be8", "ee19f8ddd9da0634245143c4b43afc7d78c549c82054a9d84007b56217dbfdd6", "aae36e094de07bc16f898e", "b6533dcbfff0f6c1ceefa84799bda3de7334326ccd65f7ce92ff3d9e6e1f140b", "254406723b0667af27e51cb3ce8fa1388164d94376c850bddb39e9bea5fa9605", "bad4837ba78822b8b165b0a16e1104c705c3c0e382d3f13c195c0ef311bb8004", "b9113a952dcc1e15c34d136603a2ef254a38755a557fa9f88c143bd3076441b0", "02b52c6ed9ad49fb38e4447c69b570ebd055e4c7fd91c020ff43461d14e02f29", 4079549063511228677, "2670dc82d39026c6cb4cd4b0f7f5aa2a4f5a5341ec5dd715406f2fdd2afa733f", "5f641c8c21862a1bafce2609d9eecfa158cfb5cd79f88008e315dc7d8388e76c", "0ffbca1d5921fa0a8c5116ae137e37f2c118d52125628d8a3f412ce0e6530e04", "e62b8ed83540146cd23cac74eed7d773d80224a5aa30d68e35572ee883d1b704"],
    ["1782fd2795d18a763624c25fa959cc97489ce75745824b77868c53239cfbdf73", "f6ef328d24761d6d3ccd25d47196e8109c038fe17c59a7f05b98d66bebc64124", "d11787ca582f948e450718b36998df28bb0f1021ea843f867f8a170f5c33901f", "9e997d9d269787268e092a7c85417da530ea42fac668a749af55dfb71cdbbe09", "136c6fe2e2b79c5156db5047d8d5e795dfc0bdc0880853a44adb7392c02f941b", "028b640564b24905de9292ba5b9810addd86bed0fb3b2d6b37f26dd238a7db13", "98d6a4bf6801d8ba0d0b67ea7b805207abc0348fc562005a59a27a8a46fa6add", "d0baef6012d308efbb769a99cca2928cede8db277645a777eaf1722cd08450b3", "cc7ce734b075a01b92aaca", "3da5273a5667c766b8231206180f158ac02af3f06ecca6ec7c38c75d33600320", "88d7b19699f394a550bc9cdc6bf3fc71f610c30656376153a6961fcd5b97fa19", "0a2dc96661b927250d7e3cd2c7e06d5174c62cb12e07167f194f4ce64e689502", "cc7965f33ac01c606851b129bdc9b6abd5ca5b9d241dbd5c18b2469b7c8cc89f", "daa242d20dfdce8fc10f4d99397da22c491dc09e1b120f6693d686ecd4030a00", 5706402952489856202, "a1df0e5b87b5bece477a709649e950060591394812951e1fe3895b8cc3d14d2c", "f6556df6ed4b4ddd3d9a69f53357d7767f4f5ccbdbc596631277f8fecd08cb05", "63cee37e3c7b4e6cc939a2e63ada74f85ea48ba07a4f92ccbd34faa42dfd4916", "4c99bfa8c20dba59bb7347da16c43b73c88794c9ebcd0dd2b25ee7bb836f9520"],
    ["6b95e3025b9792fff7f244fc716269b926d62e9596fa825c6bf21aff9e68625a", "757d158d07356b3bc2c9e51c558a9b316bddbc360b8beb6e2ae3b0618f062d2e", "449a90d2e8d1a037642a97096c916543462a137ffea37baf41ef286bb732be2c", "fd3164c632bec94ce9fb2f302263b884abb9c10e55e448647f6798495c9d083f", "c0b36b56070fff2fdf38eba11a7424957195014cba43a56bd1b1658e66a39d00", "976a8788191b87e4c13f2c6d23b4f3595e0228e245e96eef1d24b293296a191c", "1ed0eda5a4086131261a2ed4429261e4276a26d42859fabda31aa96709874371", "5e5b60c05b53d0bcd2da46a1312912515cc7cf2d974c117c8ddea9fab620c668", "99af6bf3f475bde889aaca", "acdcd348ca45ee583278303846ca078459d5be5c5dcf347e3b9a34cba124b4a3", "941a17e1202a6271a44a01666553b581bf25ef99e8e95f132ace381d96018432", "a27629ac1c62c9f4dad57c9530ab2a59800d2ef455cd17446f3fc6081a581e3b", "e9898ed6b669c8d9d590b759d0295fcfaf95e2daf7da991c2757dcefe1626e0e", "610cbd9a577979e1f71da8100f6fe6b8f6d10a747fed2a1c91cbe142475c3082", 2558469029534639129, "722db041a3ef66fa483afd3c2e19e59444a64add6df1d963f5dd5b5010d3d025", "f0287c4cf19c75f33d51ddddba5d657b43ee8da645443814cc7329f3e9b4e54c", "1e619e46bb62b61d4e1cf3622ea70a908de7f076ecf87f541e0b7b48ad4a2601", "3b948db21608e9acb22a5417b98c0dedd527a96487814e6420cbff6e4eee4e31"],
    ["236c29af3923101756d9fa4bd0f7d2ddaacb6b0f86a2658e0a07a05ac5b95005", "b4ded90d62117f18f3dd5fdb22238a35ca37c40feec845ce5fc27fe8bca5ef0f", "4efd5a2ef1ffa99a0ff62b767d44b3651ffa1c696915ac00a25ea3ac7dff9901", "02ab995ce98f63025fb62428a0fbf52f2522e6a27261078a9f4d6a36a1c05d39", "d9840d0bd89520abbca7f10be6eba366f86ec3b78dbdf1ebfe20d99512af1515", "58f5bb5c3231152529423b67fa432879112635cda0da2ec2419c6fe91ea48d24", "78f5d348672e8d209c41b783f8ca14a77b3ea3e6004ca4e0c25aa44563981dcb", "5d7fe396bbfd2267aca711ab5b3e1f024f4911f3a181732f1322a1592f9e0ebe", "2fbe4b4b1edff33123ce65", "eb2c6fee341eade07d7487997aa723697d05e62960df379c9e4a8d476dfac5bf", "663b67d3ac159927f06e6c8dab80a58967c545daac3d98729a0bcc41fd536d2b", "aa6acc8a7aa9a8052004ff93833f4abb153b45797fd907e305c8927bb0378220", "bfd1096727b6d5a2e17acbc5b24680cb88db34cf53b6b7466cef676fb3f72229", "47bdf9271ecc50e705c521cd0dbbaf1c4e6a962fc9141348b8bd7b35c4001e62", 15425828902564319772, "736c23357c85f45791e1708029d9824d90704607f387a03e49bf983657443134", "5a7877efaa8a08e73081ef8d62cb780ab6883a50a0d470190dfba10a857f8284", "c8528f722cd3e47dc99e1e388056370815a9d037973d85cac7ea38b5a716fa3b", "acc2ed2c7e3b197e5cdb4a576357d5f135391626c7a825d10aa260ae0b958128"],
    ["2d3825b3d6da0573d316eb160dc0b716c48fbd467f75b780149ae8808f4e68f5", "2d6e973e1754d41787934c34558cfe993844199972d9a6348b7a3dadfcb6772a", "762159a414f574b539750f22c8863b02d25cc10c9071fc0219e97f9392d0670c", "2591edf7ef4cf2184c34be93fcf612915042f15ab5084b14e166795b09cea133", "758fb250dd2950e5d2b2eed7ffcf94ae67cde125b95b479e2377813a85a03d2f", "6ea4363cb2df62b10da1308a0b9679bd0f7495ffe7d4e2618f54df9b670c3316", "a63cbcd31ba136d83b8f1e88efb60055ef6f98252ddbd75f625f44dcb6632c72", "02f07408f33e8712e4c9ec42de5604200109861724d33eb6368b70f65e0a1621", "08df1d4b45c673a459ff58", "268cc24b38a62880b6ee3cbcb85a712fa686cffca6db2feec5f3c3566f84218f", "0057377461f2191a7eca2b02edfd9c9b44845d2fdb8a99c76120527e53dd0917", "8162973509470c44241911c06d04029f5f1f0e9851e32ba69b18e58105dd4e2b", "6947910ea3e7331d15a71a64b2a8c16a6da08e6f3429db26f937ab9dd133b5fd", "327f76cc4244ce0a9148a35a7ea6228d441c4c7b05bd02657ceaabb609bc3c52", 12606128263924155660, "12f6b02fe806b94569cd4059f396bf29b99d0a40e5e1711ca944f72d436a102f", "ca4b97693da0b086fe9d2e7162470d02e0f05d4bec9512bfb3f38327296efaa7", "6a1195aa0536f60ecfaecbdf5374e494ea072a2b867b5f694340c96fc370a910", "b0f1602a2b1af2fc55f15950a6838385e5e39fecfd05ccec799b75c65c8da235"],
    ["4328b118c27402c70c3a90b49ad4bbc68e37c0aa7d9b3fe17799d73b841e7517", "28dc45f11544425c1bef8661da11155fdbb7e3bcfc0f0d49e6f131e7c09d352f", "0d211a9060fbaa664e41a734ad1d8d4b025f8cc160e1f4e95f0a853ebc416a2b", "3e88f2071fd9a2bb26cda2ea856aa0fb3a80a87d2fb6136fab85e36c5b38d824", "2c373882c408cd5fd482a0c9816fc32203a10fbfce0e200ccfd9ee307c5e1224", "bb9e20b2991c996da21e3ecd39fb7b3aa2babc6bde186f7dd8a875d10c51a430", "9321838a2db7f168f0ce77c45b211ffbb9b365e85e6731d909700553de492b28", "3df583361b3338bb6815f85872e39f04df5008524884af0f8c559716fcb14958", "4c4064c47a5ca6e75d4644", "f517174be258923278cf458908c0735649f1899db99c3ba9003f4ba30ab0d210", "d809a2a3d36ef96dc563f8a7b413908bfdffc06d51064849ef886b6a1d1d7c3f", "ae18a9a42512387f92eec134bde528b62b61e9956f9fb3c7d65e1945da34f309", "67a6d84a8166326cf34cedffd4298a13b801cb122d5f3329a1599f31eadf5b17", "a0073addfb89c9cc349ead5a92b7d417fe0e61f4a7e56669c907d41746c072b9", 625536973899669523, "03fd69442eb7681ec2a05600054e92eed555028f21b6a155268a2dd6640a6930", "1a52a38d4d9f9f957ae35af7167118141ce4c9be0a6a492fe79f1581a155fa3a", "f70ebf0f5ee5da6c6cdeff8fec2f8eed65c88e6755daf114d554af1967a7f40a", "95649728465e682ac057ad876294d700c27feba2f750922f955185706261c30c"]
]

@unittest.skipUnless(not utils.BITCOIN_ONLY, "altcoin")
class TestZcashOrchardKeyComponents(unittest.TestCase):
    def test_zcash_orchard_key_components(self):
        for tv in zcash_parse(ZCASH_TEST_VECTORS):
            ask = sk_to_ask(tv.sk)
            self.assertEqual(ask.to_bytes() , tv.ask)

            fvk = FullViewingKey.from_spending_key(tv.sk)
            self.assertEqual(fvk.ak.to_bytes(), tv.ak)
            self.assertEqual(fvk.nk.to_bytes(), tv.nk)
            self.assertEqual(fvk.rivk.to_bytes(), tv.rivk)
            ifvk = fvk.internal()
            self.assertEqual(ifvk.rivk.to_bytes(), tv.internal_rivk)

            ivk = fvk.incoming_viewing_key()
            self.assertEqual(ivk[0:32], tv.dk)
            self.assertEqual(ivk[32:64], tv.ivk)
            iivk = ifvk.incoming_viewing_key()
            self.assertEqual(iivk[0:32], tv.internal_dk)
            self.assertEqual(iivk[32:64], tv.internal_ivk)

            ovk = fvk.outgoing_viewing_key()
            self.assertEqual(ovk, tv.ovk)
            iovk = ifvk.outgoing_viewing_key()
            self.assertEqual(iovk, tv.internal_ovk)

            address = fvk.address(0).to_bytes()
            self.assertEqual(address[0:11], tv.default_d)
            self.assertEqual(address[11:43], tv.default_pk_d)

    def test_zcash_orchard_note_commitments(self):
        for tv in zcash_parse(ZCASH_TEST_VECTORS):
            address = Address.from_bytes(tv.default_d +  tv.default_pk_d)
            note = Note(
                address,
                tv.note_v,
                Fp(tv.note_rho),
                tv.note_rseed,
            )
            self.assertEqual(
                note.commitment().extract().to_bytes(),
                tv.note_cmx,
            )
            nk = Fp(tv.nk)
            self.assertEqual(note.nullifier(nk).to_bytes(), tv.note_nf)


if __name__ == '__main__':
    unittest.main()
