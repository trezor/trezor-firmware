Major code clean-up and refactoring.
