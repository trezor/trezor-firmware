#!/usr/bin/env python3

import json
from io import TextIOWrapper
from pathlib import Path
from typing import List

import click

HERE = Path(__file__).parent
ROOT = HERE.parent.parent.resolve()
JSON_FILE = (
    ROOT / "core" / "embed" / "sec" / "tropic" / "config" / "tropic_configs.json"
)
MD_FILE = ROOT / "docs" / "core" / "misc" / "tropic_configs.md"

HEADER = f"""<!--
This file is auto-generated from the JSON configuration in `{JSON_FILE.name}`.
Do not edit this file directly. Instead, edit the JSON and run `make gen` or
`make tropic_config` in the root direcotry.
-->
"""


def print_value_lines(value_lines: List[List[str]], md_file: TextIOWrapper) -> None:
    col_count = max(len(line) for line in value_lines)
    col_len = [max(len(line[i]) for line in value_lines) for i in range(col_count)]

    line = value_lines[0]
    print(
        f"| {' | '.join(line[i].ljust(col_len[i]) for i in range(col_count))} |",
        file=md_file,
    )
    print(
        f"|{'|'.join('-' * (col_len[i] + 2) for i in range(col_count))}|", file=md_file
    )
    for line in value_lines[1:]:
        print(
            f"| {' | '.join(line[i].ljust(col_len[i]) for i in range(col_count))} |",
            file=md_file,
        )
    print("", file=md_file)


def json_to_markdown(json_filename: Path, md_filename: Path) -> None:
    with open(json_filename, "r") as json_file:
        data = json.load(json_file)

    with open(md_filename, "w") as md_file:
        print(HEADER, file=md_file)

        for config_name, config in data.items():
            print(f"# {config_name.replace('_', ' ').upper()}", file=md_file)
            for category, details in config.items():
                address = details["address"]
                print(f"## {category.upper()} ({address})", file=md_file)
                if "uap" not in category:
                    value_lines = [["Setting", "Value"]]
                    for value_name, values in details["setting"].items():
                        bit = values["bit"]
                        val = "1" if values["value"] else "0"
                        comment = values.get("comment", "")
                        comment = f"({comment})" if comment else ""
                        value_lines.append(
                            [
                                f"{value_name.upper()} (bit {bit})",
                                f"{val} {comment.upper()}",
                            ]
                        )
                    print_value_lines(value_lines, md_file)

                else:
                    value_lines = [["Setting"] + [f"Pairing Key {i}" for i in range(4)]]
                    for value_name in details["setting"]["pairing_key_0"].keys():
                        value_line = [f"{value_name.upper()}"]
                        for key in range(4):
                            values = details["setting"][f"pairing_key_{key}"][
                                value_name
                            ]
                            bit = values["bit"]
                            value = "1" if values["value"] else "0"
                            value_line.append(f"{value} (bit {bit})")
                        value_lines.append(value_line)
                    print_value_lines(value_lines, md_file)


@click.command()
@click.option("--check", is_flag=True)
def generate_tropic_config_docs(check: bool) -> None:
    if check:
        original_content = MD_FILE.read_text()

    json_to_markdown(JSON_FILE, MD_FILE)

    if check:
        new_content = MD_FILE.read_text()
        if original_content != new_content:
            MD_FILE.write_text(original_content)
            raise click.ClickException(f"{MD_FILE.name} file is out of date.")


if __name__ == "__main__":
    generate_tropic_config_docs()
